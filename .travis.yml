language: java
sudo: required
services:
  - docker
jdk:
  - oraclejdk8

env:
  global:
    - DOCKER_IMAGE_NAME="orders"
    - K8S_DEPLOYMENT_NAME="orders"
    - GROUP=microshop COMMIT=$TRAVIS_COMMIT TAG=$TRAVIS_TAG REPO=orders;

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  # - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  #         push "$REPO:$TAG";
  - export TAG="latest"
  - export NAME=$GROUP/$REPO
  - docker build -t $NAME:$TAG
  - docker tag $NAME:$TAG $NAME:$TAG
  - docker push $NAME

  # Install kubernetes and set config
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
  - chmod +x ./kubectl
  - sudo mv ./kubectl /usr/local/bin/kubectl
  - curl -o config https://$GITHUB_ACCESS_TOKEN@raw.githubusercontent.com/micro-shop/config/master/kubeconfig

  - mkdir ${HOME}/.kube
  - cp config ${HOME}/.kube/config

  # Fill out missing params in kubectl config file
  - sed -i -e 's|KUBE_CA_CERT|'"${KUBE_CA_CERT}"'|g' config
  - sed -i -e 's|KUBE_ENDPOINT|'"${KUBE_ENDPOINT}"'|g' config
  - sed -i -e 's|KUBE_TRAVIS_CERT|'"${KUBE_TRAVIS_CERT}"'|g' config
  - sed -i -e 's|KUBE_TRAVIS_KEY|'"${KUBE_TRAVIS_KEY}"'|g' config
  - sed -i -e 's|KUBE_USERNAME|'"${KUBE_USERNAME}"'|g' config
  - sed -i -e 's|KUBE_CONTEXT_NAME|'"${KUBE_CONTEXT_NAME}"'|g' config
  - sed -i -e 's|KUBE_CLUSTER_NAME|'"${KUBE_CLUSTER_NAME}"'|g' config
  - kubectl apply -f .\deployment\deployment.yml
  #- kubectl set image deployment/<deplyoment name> <deplyoment name>=<your docker registry>/<image name>:<version>